-- Generated by Ora2Pg, the Oracle database Schema converter, version 24.0
-- Copyright 2000-2023 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=172.17.0.5;sid=xe;port=1521

SET client_encoding TO 'UTF8';
SET search_path = JUROR,public;




CREATE OR REPLACE PROCEDURE pool_transfer_transfer_pool_details () AS $body$
DECLARE
  C1_sups_courts CURSOR FOR SELECT distinct(owner) owner from UNIQUE_POOL where owner <>'400';
  location_codes varchar(3);

BEGIN
	OPEN C1_sups_courts;
      PERFORM set_config('pool_transfer_ln_deadline', (SELECT SP_VALUE from SYSTEM_PARAMETER where SP_ID = 7), false);
      IF current_setting('pool_transfer_ln_deadline', false) = '' THEN
         PERFORM set_config('pool_transfer_ln_deadline', 10, false);
      END IF;

	  PERFORM set_config('pool_transfer_ld_latestreturndate', pool_transfer_get_return_date(current_setting('pool_transfer_ln_deadline')::bigint, current_setting('pool_transfer_ld_latestreturndate')::timestamp(0)));
      
	  Loop
	  FETCH C1_sups_courts into location_codes;
	        Begin
	           CALL pool_transfer_transfer_pool(location_codes.owner);
	           CALL pool_transfer_transfer_court_unique_pool(location_codes.owner);
	           commit; -- commit the transaction for each court.
	           EXCEPTION
		                  WHEN OTHERS THEN
			                CALL pool_transfer_write_error_message('POOL TRANSFER', 'LOC_CODE :'||location_codes.owner||' : '||SQLERRM);
			                rollback;
			                PERFORM set_config('pool_transfer_g_job_status', false, false);
	       End;
      End loop;
	IF NOT current_setting('pool_transfer_g_job_status')::boolean THEN
		RAISE EXCEPTION '%', 'Error in Pool Transfer Procedure. Not all pools are transferred.' USING ERRCODE = '45001';
		RAISE EXCEPTION '%', 'Check ERROR_LOG table for failed Locations.' USING ERRCODE = '45001';
	END IF;
	commit;
    EXCEPTION
		    WHEN OTHERS THEN
			  CALL pool_transfer_write_error_message('POOL TRANSFER', SQLERRM);
			  rollback;
			  raise;
END;

$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE pool_transfer_transfer_pool_details () FROM PUBLIC;
