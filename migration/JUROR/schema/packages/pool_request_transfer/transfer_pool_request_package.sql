-- Generated by Ora2Pg, the Oracle database Schema converter, version 24.0
-- Copyright 2000-2023 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=172.17.0.5;sid=xe;port=1521

SET client_encoding TO 'UTF8';
SET search_path = JUROR,public;




CREATE OR REPLACE PROCEDURE pool_request_transfer_transfer_pool_request () AS $body$
DECLARE
  g_job_status boolean;
  location_codes varchar(2);
  err_code text;
  exc_message text;
  exc_detail text;
  exc_hint text;
  ret boolean := false;

     --declare the variable used in the procedure
  C1_sups_courts CURSOR FOR SELECT distinct(owner) owner from UNIQUE_POOL where owner <>'400';

BEGIN
	OPEN C1_sups_courts;
	Loop
	    FETCH C1_sups_courts into location_codes;
          Begin
                 CALL juror.pool_request_transfer_transfer_unique_pool(location_codes.owner);
           	     commit; -- commit the transaction for each court.
          EXCEPTION
		      WHEN OTHERS THEN
			  GET STACKED DIAGNOSTICS  err_code = RETURNED_SQLSTATE,
					  exc_message = MESSAGE_TEXT,
                      exc_detail = PG_EXCEPTION_DETAIL,
                      exc_hint = PG_EXCEPTION_HINT;
			  call juror.pool_request_transfer_write_error_message('POOL REQUEST TRANSFER', 'LOC_CODE :'||location_codes.owner||' : '||'Error code ' || err_code || ' - ' || exc_message || ':' || exc_detail || ': ' || exc_hint, ret);
			  rollback;
			  g_job_status := false;
          End;
	End loop;

			IF NOT g_job_status THEN
			  RAISE EXCEPTION '%', 'Error in Pool Request Procedure. Not all pools are transferred. Check ERROR_LOG table for failed Locations' USING ERRCODE = '45001';
			END IF;

    EXCEPTION
		    WHEN OTHERS THEN
			GET STACKED DIAGNOSTICS  err_code = RETURNED_SQLSTATE,
					  exc_message = MESSAGE_TEXT,
                      exc_detail = PG_EXCEPTION_DETAIL,
                      exc_hint = PG_EXCEPTION_HINT;

			  call juror.pool_request_transfer_write_error_message('POOL REQUEST TRANSFER', 'Error code ' || err_code || ' - ' || exc_message || ':' || exc_detail || ': ' || exc_hint, ret);
			  rollback;
			  raise;
    END;

$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE pool_request_transfer_transfer_pool_request () FROM PUBLIC;
