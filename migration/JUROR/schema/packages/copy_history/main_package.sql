-- Generated by Ora2Pg, the Oracle database Schema converter, version 24.0
-- Copyright 2000-2023 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=172.17.0.5;sid=xe;port=1521

SET client_encoding TO 'UTF8';
SET search_path = JUROR,public;




CREATE OR REPLACE PROCEDURE copy_history_main (l_from_court text, l_to_court text, l_to_pool_no text) AS $body$
DECLARE
  lc_Job_Type text := 'copy_history_main()';
BEGIN


  /** Copy part_hist avoiding duplicating history already at receiving court */

	INSERT INTO part_hist(Owner,part_no,date_part,history_code,user_id,other_information,pool_no)

    	SELECT  c_to.context_id, h.part_no,date_part,history_code,user_id,other_information,h.pool_no
    	FROM	part_hist h,
            context_data c_from,
            context_data c_to,
            pool p
    	WHERE	h.owner = c_from.context_id
      and c_from.loc_code = l_from_court
      and c_to.loc_code = l_to_court
    	AND	h.part_no = p.part_no
      and p.owner = c_to.context_id
      and p.pool_no = l_to_pool_no
      and is_active ='Y' 
      
      EXCEPT
    
    	SELECT  context_id, h.part_no,date_part,history_code,user_id,other_information,h.pool_no
    	FROM	part_hist h,
            context_data c,
            pool p
    	WHERE	h.owner = c.context_id
      and c.loc_code = l_to_court
    	AND	h.part_no = p.part_no
      and p.owner = c.context_id
      and p.pool_no = l_to_pool_no  
      and is_active ='Y';

  /** Copy phone_log avoiding duplicating entries already at receiving court */

  INSERT INTO phone_log(owner,part_no,start_call,user_id,end_call,phone_code,notes)

    	SELECT  c_to.context_id, h.part_no,start_call,user_id,end_call,phone_code,h.notes
    	FROM	phone_log h,
            context_data c_from,
            context_data c_to,
            pool p
    	WHERE	h.owner = c_from.context_id
      and c_from.loc_code = l_from_court
      and c_to.loc_code = l_to_court
    	AND	h.part_no = p.part_no
      and p.owner = c_to.context_id
      and p.pool_no = l_to_pool_no  
      and is_active ='Y' 
      
      EXCEPT
    
    	SELECT  context_id, h.part_no,start_call,user_id,end_call,phone_code,h.notes
    	FROM	phone_log h,
            context_data c,
            pool p
    	WHERE	h.owner = c.context_id
      and c.loc_code = l_to_court
    	AND	h.part_no = p.part_no
      and p.owner = c.context_id
      and p.pool_no = l_to_pool_no  
      and is_active ='Y';

  /** Copy part_amendments avoiding duplicating entries already at receiving court */

  INSERT INTO part_amendments(owner,part_no,edit_date,edit_userid,title,fname,lname, dob, address, zip,sort_code, bank_acct_name, bank_acct_no, bldg_soc_roll_no, pool_no )

	    SELECT c_to.context_id, h.part_no,edit_date,edit_userid,h.title,h.fname,h.lname, h.dob, h.address,
             h.zip,h.sort_code, h.bank_acct_name, h.bank_acct_no, h.bldg_soc_roll_no, h.pool_no
    	FROM	part_amendments h,
            context_data c_from,
            context_data c_to,
            pool p
    	WHERE	h.owner = c_from.context_id
      and c_from.loc_code = l_from_court
      and c_to.loc_code = l_to_court
    	AND	h.part_no = p.part_no
      and p.owner = c_to.context_id
      and p.pool_no = l_to_pool_no  
      and is_active ='Y' 
      
      EXCEPT
    
	    SELECT context_id, h.part_no,edit_date,edit_userid,h.title,h.fname,h.lname, h.dob, h.address,
             h.zip,h.sort_code, h.bank_acct_name, h.bank_acct_no, h.bldg_soc_roll_no, h.pool_no
    	FROM	part_amendments h,
            context_data c,
            pool p
    	WHERE	h.owner = c.context_id
      and c.loc_code = l_to_court
    	AND	h.part_no = p.part_no
      and p.owner = c.context_id
      and p.pool_no = l_to_pool_no  
      and is_active ='Y';

  
  -- No COMMIT here as app will perform the commit
    EXCEPTION
        when others then
       CALL juror.copy_history_write_error(sqlerrm);
 	      rollback;
       raise;
END;

$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE copy_history_main (l_from_court text, l_to_court text, l_to_pool_no text) FROM PUBLIC;
