-- Generated by Ora2Pg, the Oracle database Schema converter, version 24.0
-- Copyright 2000-2023 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=172.17.0.5;sid=xe;port=1521

SET client_encoding TO 'UTF8';

SET search_path = JUROR,public;
\set ON_ERROR_STOP ON


CREATE OR REPLACE FUNCTION word_wrap(p_string text, p_len bigint DEFAULT 35) RETURNS TEXT AS $$
DECLARE
l_string    text := REPLACE( p_string || CHR(10), CHR(9), '    ' );
l_result    text := NULL;
l_piece     text;
l_ws        varchar(25) := ' ' || CHR(9);
l_sep       varchar(5) := NULL;
n           bigint;

BEGIN
   LOOP
         EXIT WHEN l_string IS NULL;
         n := position(CHR(10)  in l_string);
         l_piece := SUBSTR( l_string, 1, n-1 );
      l_string := SUBSTR( l_string, n+1 );
      LOOP
         EXIT WHEN l_piece IS NULL;
            n := LENGTH(l_piece);
         IF ( n > p_len ) THEN
            n := INSTR( SUBSTR(TRANSLATE(l_piece,l_ws,RPAD(' ',LENGTH(l_ws))), 1, p_len ), ' ', -1);
               IF ( coalesce(n,0) = 0 ) THEN
               n := p_len;
               END IF;
            END IF;
         l_result := l_result || l_sep || SUBSTR( l_piece, 1, n );
            l_sep := CHR(10);
            l_piece := SUBSTR( l_piece, n+1 );
      END LOOP;
   END LOOP;
   RETURN l_result;
END;
$$ 
LANGUAGE plpgsql
SECURITY DEFINER 
STABLE;



CREATE OR REPLACE FUNCTION JUROR.Get_Pool_Comments (pd_StartDate timestamp(0), pd_EndDate timestamp(0), pc_LocCode text) RETURNS varchar AS $body$
DECLARE


/******************************************************************************
   NAME:       GET_POOL_COMMENTS
   PURPOSE:    To concatenate the comments for a given location

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        28-05-2003   Jeeva Konar       1. Created this function.

   PARAMETERS:
   INPUT	  		:	  pd_StartDate Date, pd_EndDate Date, pc_LocCode Varchar2
   OUTPUT:
   RETURNED VALUE	:	  Varchar2
   CALLED BY		:	  yield_performance_report in PowerBuilder application


   ******************************************************************************/
   c1 CURSOR(cd_StartDate timestamp(0), cd_EndDate timestamp(0), cc_PoolNo text)
   IS
      SELECT  POOL_NO, PCOMMENT
      FROM   POOL_COMMENTS pc
      WHERE  POOL_NO  IN (
                  SELECT POOL_NO 
                  FROM   UNIQUE_POOL up 
                  WHERE  RETURN_DATE BETWEEN cd_StartDate AND cd_EndDate
                  AND   POOL_NO LIKE cc_PoolNo)
      ORDER BY POOL_NO, LAST_UPDATE;
      
   lc_Comments varchar(2000);
   lc_TempComments varchar(100);

   BEGIN
      FOR i IN c1(pd_StartDate, pd_EndDate, pc_LocCode||'%') LOOP
      lc_TempComments := word_wrap(i.pool_no||' : '||i.pcomment,28);
         lc_Comments := lc_Comments||lc_TempComments||CHR(13);
   END LOOP;

   RETURN coalesce(lc_Comments,'');

   EXCEPTION
      WHEN OTHERS THEN
      RETURN ''	;

   END;
   $body$
   LANGUAGE PLPGSQL
   SECURITY DEFINER
   STABLE;
   -- REVOKE ALL ON FUNCTION JUROR.Get_Pool_Comments (pd_StartDate timestamp(0), pd_EndDate timestamp(0), pc_LocCode text) FROM PUBLIC;

